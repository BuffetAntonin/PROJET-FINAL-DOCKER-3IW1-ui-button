version: '3.8'  # Version du format Docker Compose

services:
  # --- Base de données MySQL ---
  mysql:
    image: mysql:8                       # Utilise MySQL version 8
    container_name: tp_mysql             # Nom du container
    restart: always                      # Redémarre automatiquement si le container plante
    env_file: ./.env.db                  # Charge les variables d'environnement depuis un fichier externe
    volumes:
      - mysql-data:/var/lib/mysql        # Persistance des données MySQL
    networks:
      - laravel-net                      # Connecté au réseau interne
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]  # Vérifie que MySQL est prêt
      timeout: 20s
      retries: 10

  # --- Serveur 1 (PHP FPM) ---
  serveur1:
    build: ./php                         # Construit l'image à partir du Dockerfile dans ./php
    container_name: php_fpm1
    restart: always
    volumes:
      - ./Serveur1:/var/www/html         # Monte le code du Serveur 1 dans le container
    env_file: ./.env.db
    environment:
      DB_HOST: mysql                      # Doit correspondre au nom du service MySQL
      DB_PORT: 3306
      APP_NAME: "Serveur 1"
      RUN_MIGRATIONS: "true"             # Ce serveur exécutera les migrations
    depends_on:
      mysql:
        condition: service_healthy       # Attend que MySQL soit prêt
    networks:
      - laravel-net

  # --- Serveur 1 (Nginx) ---
  nginx1:
    image: nginx:alpine
    container_name: nginx1
    restart: always
    ports:
      - "8080:80"                         # Accès via http://localhost:8080
    volumes:
      - ./Serveur1:/var/www/html          # Partage le même code que le serveur PHP
      - ./nginx/nginx1.conf:/etc/nginx/conf.d/default.conf # Configuration Nginx
    depends_on:
      - serveur1
    networks:
      - laravel-net

  # --- Serveur 2 (PHP FPM) ---
  serveur2:
    build: ./php                         # Réutilise le même Dockerfile que serveur1
    container_name: php_fpm2
    restart: always
    volumes:
      - ./Serveur2:/var/www/html         # Monte le code du Serveur 2
    env_file: ./.env.db
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      APP_NAME: "Serveur 2"
      RUN_MIGRATIONS: "false"            # Ce serveur ne fait pas les migrations
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - laravel-net

  # --- Serveur 2 (Nginx) ---
  nginx2:
    image: nginx:alpine
    container_name: nginx2
    restart: always
    ports:
      - "8081:80"                         # Accès via http://localhost:8081
    volumes:
      - ./Serveur2:/var/www/html
      - ./nginx/nginx2.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - serveur2
    networks:
      - laravel-net

# --- Volumes persistants ---
volumes:
  mysql-data:                             # Stocke les données MySQL

# --- Réseaux personnalisés ---
networks:
  laravel-net:
    driver: bridge                        # Réseau interne entre tous les containers Laravel
